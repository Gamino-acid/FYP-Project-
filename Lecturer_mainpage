<?php
session_start();
include("db_connect.php");

if (!isset($_SESSION['user_id']) || !isset($_SESSION['user_role']) || $_SESSION['user_role'] !== 'lecturer') {
    header("Location: Login.php");
    exit;
}

$auth_user_id = $_SESSION['user_id'];
$current_page = $_GET['page'] ?? 'dashboard';

$sql = "SELECT u.fyp_userid, u.fyp_username, u.fyp_usertype, s.fyp_email, s.fyp_contactno, s.fyp_profileimg
        FROM `user` u
        JOIN `supervisor` s ON s.fyp_userid = u.fyp_userid
        WHERE u.fyp_userid = ? AND u.fyp_usertype = 'lecturer'
        LIMIT 1";
$stmt = $conn->prepare($sql);
if ($stmt === false) {
    die($conn->error);
}
$stmt->bind_param("i", $auth_user_id);
$stmt->execute();
$result = $stmt->get_result();
$lect_data = $result->fetch_assoc();
$stmt->close();

if (!$lect_data) {
    header("Location: Login.php");
    exit;
}

$user_name = $lect_data['fyp_username'];

if ($current_page === 'profile' && $_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['update_profile'])) {
        $email = trim($_POST['email']);
        $phone = trim($_POST['phone']);
        $sql = "UPDATE `supervisor` SET fyp_email = ?, fyp_contactno = ? WHERE fyp_userid = ?";
        $stmt = $conn->prepare($sql);
        $stmt->bind_param("ssi", $email, $phone, $auth_user_id);
        $stmt->execute();
        if ($stmt->affected_rows === 0) {
            die('Profile not updated: email/phone unchanged or supervisor row not matched');
        }
        $stmt->close();

        if (!empty($_FILES['profile_img']['name'])) {
            if ($_FILES['profile_img']['error'] === UPLOAD_ERR_OK) {
                $allowed = ['jpg','jpeg','png'];
                $ext = strtolower(pathinfo($_FILES['profile_img']['name'], PATHINFO_EXTENSION));
                if (in_array($ext, $allowed) && $_FILES['profile_img']['size'] <= 2 * 1024 * 1024) {
                    $imgData = file_get_contents($_FILES['profile_img']['tmp_name']);
                    $base64 = 'data:image/' . $ext . ';base64,' . base64_encode($imgData);
                    $sqlImg = "UPDATE supervisor SET fyp_profileimg = ? WHERE fyp_userid = ?";
                    $stmtImg = $conn->prepare($sqlImg);
                    $stmtImg->bind_param("si", $base64, $auth_user_id);
                    $stmtImg->execute();
                    if ($stmtImg->affected_rows === 0) {
                        die('Profile image not updated');
                    }
                    $stmtImg->close();
                }
            }
        }
    }

    if (isset($_POST['change_password'])) {
        $p1 = $_POST['new_password'];
        $p2 = $_POST['confirm_password'];
        if ($p1 === $p2 && strlen($p1) >= 6) {
            $hash = password_hash($p1, PASSWORD_DEFAULT);
            $sql = "UPDATE `user` SET fyp_passwordhash = ? WHERE fyp_userid = ?";
            $stmt = $conn->prepare($sql);
            $stmt->bind_param("si", $hash, $auth_user_id);
            $stmt->execute();
            $stmt->close();
        }
    }

    header("Location: ?page=profile");
    exit;
}

$dashboard_data = [
    'total_students' => 0,
    'pending_projects' => 0,
    'next_meeting' => 'Not Scheduled'
];

$my_students = [];
if ($current_page === 'my_students') {
    $sql = "
        SELECT
            p.fyp_pairingid,
            st.fyp_studid,
            st.fyp_studfullid,
            st.fyp_studname,
            st.fyp_email
        FROM supervisor sv
        JOIN pairing p ON p.fyp_supervisorid = sv.fyp_supervisorid
        JOIN student_pairing sp ON sp.fyp_pairingid = p.fyp_pairingid
        JOIN student st ON st.fyp_studid = sp.fyp_studid
        WHERE sv.fyp_userid = ?
        ORDER BY p.fyp_pairingid
    ";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("i", $auth_user_id);
    $stmt->execute();
    $res = $stmt->get_result();
    while ($row = $res->fetch_assoc()) {
        $my_students[] = $row;
    }
    $stmt->close();
}

$menu_items = [
    'dashboard' => ['name' => 'Dashboard', 'icon' => 'fa-home'],
    'profile' => ['name' => 'My Profile', 'icon' => 'fa-user-tie'],
    'supervision' => [
        'name' => 'Supervision',
        'icon' => 'fa-users',
        'sub_items' => [
            'my_students' => ['name' => 'My Students', 'icon' => 'fa-user-graduate'],
            'project_approval' => ['name' => 'Project Approval', 'icon' => 'fa-check-circle'],
        ]
    ],
    'appointments' => ['name' => 'Appointments', 'icon' => 'fa-calendar-alt'],
    'announcements' => ['name' => 'Announcements', 'icon' => 'fa-bullhorn'],
];
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lecturer Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/Student_mainpage.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div id="st-container" class="st-container">

<nav class="st-menu" id="menu-1">
    <div class="sidebar-profile">
        <?php $img_src = !empty($lect_data['fyp_profileimg']) ? $lect_data['fyp_profileimg'] : "https://ui-avatars.com/api/?name=" . urlencode($user_name) . "&background=random"; ?>
        <img src="<?= $img_src; ?>" alt="Profile">
        <div class="student-name"><?= htmlspecialchars($user_name); ?></div>
        <div class="student-id">Lecturer</div>
    </div>

    <ul class="sidebar-nav">
        <?php foreach ($menu_items as $key => $item): ?>
            <li>
                <a href="?page=<?= $key; ?>" class="<?= ($key === $current_page ? 'active' : ''); ?>">
                    <i class="fa <?= $item['icon']; ?>"></i> <?= $item['name']; ?>
                </a>
                <?php if (isset($item['sub_items'])): ?>
                    <ul class="sidebar-subnav">
                        <?php foreach ($item['sub_items'] as $sub_key => $sub): ?>
                            <li>
                                <a href="?page=<?= $sub_key; ?>" class="<?= ($sub_key === $current_page ? 'active' : ''); ?>">
                                    <i class="fa <?= $sub['icon']; ?>"></i> <?= $sub['name']; ?>
                                </a>
                            </li>
                        <?php endforeach; ?>
                    </ul>
                <?php endif; ?>
            </li>
        <?php endforeach; ?>
    </ul>

    <div class="sidebar-footer">
        <a href="Login.php"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
</nav>

<div class="st-pusher">
<header class="header">
    <div class="header-left">
        <div class="menu-trigger" id="trigger-effects"><i class="fas fa-bars"></i></div>
        <div class="logo">Lecturer Portal</div>
    </div>
    <div class="header-right">
        <span><?= htmlspecialchars($user_name); ?></span>
    </div>
</header>

<div class="main-scroll">

<?php if ($current_page === 'dashboard'): ?>
<div class="card">
    <div class="card-header"><h3>Dashboard</h3></div>
    <div class="card-body">
        <p>Total Students: <?= $dashboard_data['total_students']; ?></p>
        <p>Pending Projects: <?= $dashboard_data['pending_projects']; ?></p>
        <p>Next Meeting: <?= $dashboard_data['next_meeting']; ?></p>
    </div>
</div>
<?php elseif ($current_page === 'profile'): ?>
<div class="card">
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
            <div style="display:flex; gap:30px; flex-wrap:wrap;">
                <div style="width:200px; text-align:center;">
                    <div style="width:150px; height:150px; border-radius:50%; overflow:hidden; margin:0 auto 15px; border:4px solid #eee;">
                        <img src="<?= $img_src; ?>" alt="Profile" style="width:100%; height:100%; object-fit:cover;">
                    </div>
                    <input type="file" name="profile_img" accept="image/*" style="width:100%; font-size:0.8rem;">
                </div>

                <div style="flex:1;">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" value="<?= htmlspecialchars($user_name); ?>" readonly style="background:#f9f9f9;">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" value="<?= htmlspecialchars($lect_data['fyp_email']); ?>" required>
                    </div>
                    <div class="form-group">
                        <label style="color:#42a5f5; font-weight:bold;">Phone Number (Editable)</label>
                        <input type="text" name="phone" value="<?= htmlspecialchars($lect_data['fyp_contactno']); ?>" required style="border:1px solid #42a5f5;">
                    </div>
                    <button type="submit" name="update_profile" class="save-btn">Save Changes</button>
                </div>
            </div>

            <hr>

            <div style="margin-top:20px;">
                <h4>Change Password</h4>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" name="new_password">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" name="confirm_password">
                </div>
                <button type="submit" name="change_password" class="save-btn">Change Password</button>
            </div>
        </form>
    </div>
</div>
<?php elseif ($current_page === 'my_students'): ?>
<div class="card">
    <div class="card-header"><h3>My Students</h3></div>
    <div class="card-body">
        <?php if (empty($my_students)): ?>
            <p>No students assigned yet.</p>
        <?php else: ?>
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr>
                        <th>Group</th>
                        <th>Student ID</th>
                        <th>Student Name</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody>
                <?php foreach ($my_students as $s): ?>
                    <tr>
                        <td><?= htmlspecialchars($s['fyp_pairingid']); ?></td>
                        <td><?= htmlspecialchars($s['fyp_studfullid']); ?></td>
                        <td><?= htmlspecialchars($s['fyp_studname']); ?></td>
                        <td><?= htmlspecialchars($s['fyp_email']); ?></td>
                    </tr>
                <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    </div>
</div>
<?php else: ?>
<div class="card"><div class="card-body">Module Under Construction</div></div>
<?php endif; ?>

</div>
</div>
</div>

<script>
const container = document.getElementById('st-container');
document.getElementById('trigger-effects').onclick = () => container.classList.toggle('st-menu-open');
</script>
</body>
</html>
